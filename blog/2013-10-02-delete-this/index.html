<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/site/styles.67d71cce92f67b5b9860.css">code[class*=language-],pre[class*=language-]{color:#c5c8c6;text-shadow:0 1px rgba(0,0,0,.3);font-family:Inconsolata,Monaco,Consolas,Courier New,Courier,monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#1d1f21}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#7c7c7c}.token.punctuation{color:#c5c8c6}.namespace{opacity:.7}.token.keyword,.token.property,.token.tag{color:#96cbfe}.token.class-name{color:#ffffb6;text-decoration:underline}.token.boolean,.token.constant{color:#9c9}.token.deleted,.token.symbol{color:#f92672}.token.number{color:#ff73fd}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#a8ff60}.token.variable{color:#c6c5fe}.token.operator{color:#ededed}.token.entity{color:#ffffb6;cursor:help}.token.url{color:#96cbfe}.language-css .token.string,.style .token.string{color:#87c38a}.token.atrule,.token.attr-value{color:#f9ee98}.token.function{color:#dad085}.token.regex{color:#e9c062}.token.important{color:#fd971f}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}pre[class*=language-].line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}pre[class*=language-].line-numbers>code{position:relative;white-space:inherit}.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:0;font-size:100%;left:-3.8em;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-ms-user-select:none;user-select:none}.line-numbers-rows>span{display:block;counter-increment:linenumber}.line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}@font-face{font-family:Nunito;font-style:normal;font-display:swap;font-weight:200;src:local("Nunito Extra Light "),local("Nunito-Extra Light"),url(/site/static/nunito-latin-200-2a4f4b0a3646be9d8560178ebc4306e5.woff2) format("woff2"),url(/site/static/nunito-latin-200-249c20ee4450b15795cdde4cbb5f38d8.woff) format("woff")}@font-face{font-family:Nunito;font-style:italic;font-display:swap;font-weight:200;src:local("Nunito Extra Light italic"),local("Nunito-Extra Lightitalic"),url(/site/static/nunito-latin-200italic-89ba5530f3b2c751f2a49e25f31e3f15.woff2) format("woff2"),url(/site/static/nunito-latin-200italic-67d3d63c0ac28ccbc0c0fcbda8e66e04.woff) format("woff")}@font-face{font-family:Nunito;font-style:normal;font-display:swap;font-weight:300;src:local("Nunito Light "),local("Nunito-Light"),url(/site/static/nunito-latin-300-895205e22ad7d4d866df7102352077cd.woff2) format("woff2"),url(/site/static/nunito-latin-300-cad1324b066f52f764cf080d9244c8b2.woff) format("woff")}@font-face{font-family:Nunito;font-style:italic;font-display:swap;font-weight:300;src:local("Nunito Light italic"),local("Nunito-Lightitalic"),url(/site/static/nunito-latin-300italic-f4a613c73f19da60cf08aa42b2a9249b.woff2) format("woff2"),url(/site/static/nunito-latin-300italic-1fde36925a8493f45651815dd89d22a7.woff) format("woff")}@font-face{font-family:Nunito;font-style:normal;font-display:swap;font-weight:400;src:local("Nunito Regular "),local("Nunito-Regular"),url(/site/static/nunito-latin-400-de6068bf97f40206af0b062e262e6213.woff2) format("woff2"),url(/site/static/nunito-latin-400-6386ba6af7b7a5480eb5efda82ff803c.woff) format("woff")}@font-face{font-family:Nunito;font-style:italic;font-display:swap;font-weight:400;src:local("Nunito Regular italic"),local("Nunito-Regularitalic"),url(/site/static/nunito-latin-400italic-6ca737afe5cef0c0a9c9bbfec4e398ff.woff2) format("woff2"),url(/site/static/nunito-latin-400italic-ef2e2a0d9dd85cf89526d1f27f8fbbef.woff) format("woff")}@font-face{font-family:Nunito;font-style:normal;font-display:swap;font-weight:600;src:local("Nunito SemiBold "),local("Nunito-SemiBold"),url(/site/static/nunito-latin-600-b10ecee279e3a8d11d5ec3193b68d8bf.woff2) format("woff2"),url(/site/static/nunito-latin-600-c3de23017bcb95715e6eb11dd6a10fc5.woff) format("woff")}@font-face{font-family:Nunito;font-style:italic;font-display:swap;font-weight:600;src:local("Nunito SemiBold italic"),local("Nunito-SemiBolditalic"),url(/site/static/nunito-latin-600italic-97d4f64b213f3e5163827754c213bb4e.woff2) format("woff2"),url(/site/static/nunito-latin-600italic-4f62b81ff327bd0ffadcb7b82e6c13b2.woff) format("woff")}@font-face{font-family:Nunito;font-style:normal;font-display:swap;font-weight:700;src:local("Nunito Bold "),local("Nunito-Bold"),url(/site/static/nunito-latin-700-91ae827aa880d02ea567979add1da58c.woff2) format("woff2"),url(/site/static/nunito-latin-700-623f5ed42b0b347fb4531ded4e4b57a2.woff) format("woff")}@font-face{font-family:Nunito;font-style:italic;font-display:swap;font-weight:700;src:local("Nunito Bold italic"),local("Nunito-Bolditalic"),url(/site/static/nunito-latin-700italic-b94caac4c88b1fe6c4faf6256646f42e.woff2) format("woff2"),url(/site/static/nunito-latin-700italic-3aabf345871453097c2d8762411d187e.woff) format("woff")}@font-face{font-family:Nunito;font-style:normal;font-display:swap;font-weight:800;src:local("Nunito ExtraBold "),local("Nunito-ExtraBold"),url(/site/static/nunito-latin-800-36e4c9b478c2e2adb339a76d819eed7e.woff2) format("woff2"),url(/site/static/nunito-latin-800-33c733aff58ea08126616f346cbf4f4a.woff) format("woff")}@font-face{font-family:Nunito;font-style:italic;font-display:swap;font-weight:800;src:local("Nunito ExtraBold italic"),local("Nunito-ExtraBolditalic"),url(/site/static/nunito-latin-800italic-0f20328772c0d84250ef397c129607fb.woff2) format("woff2"),url(/site/static/nunito-latin-800italic-672d2afe4f40a766e46ff95379550c4f.woff) format("woff")}@font-face{font-family:Nunito;font-style:normal;font-display:swap;font-weight:900;src:local("Nunito Black "),local("Nunito-Black"),url(/site/static/nunito-latin-900-b296e05d0932e16d500b753becdb338e.woff2) format("woff2"),url(/site/static/nunito-latin-900-cbf4339e858edf2b14d20140b2887343.woff) format("woff")}@font-face{font-family:Nunito;font-style:italic;font-display:swap;font-weight:900;src:local("Nunito Black italic"),local("Nunito-Blackitalic"),url(/site/static/nunito-latin-900italic-ae87e7b4e2d3825919b9bc6c82039b80.woff2) format("woff2"),url(/site/static/nunito-latin-900italic-602859bd469800c6205701f5a16b1a1b.woff) format("woff")}code{background-color:rgba(0,0,0,.04)}body{margin:0;font-family:Nunito,Avenir,Helvetica,"sans-serif";-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{font-style:normal;color:rgba(0,0,0,.8);-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:112.5%/1.45em georgia,serif;box-sizing:border-box;overflow-y:scroll}*,:after,:before{box-sizing:inherit}body{color:rgba(0,0,0,.8);font-weight:400;word-wrap:break-word;-webkit-font-kerning:normal;font-kerning:normal;-ms-font-feature-settings:"kern","liga","clig","calt";font-feature-settings:"kern","liga","clig","calt"}img{max-width:100%;padding:0;margin:0 0 1.45rem}h1{font-size:2.25rem}h1,h2{padding:0;margin:0 0 1.45rem;color:inherit;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h2{font-size:1.62671rem}h3{font-size:1.38316rem}h3,h4{padding:0;margin:0 0 1.45rem;color:inherit;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h4{font-size:1rem}h5{font-size:.85028rem}h5,h6{padding:0;margin:0 0 1.45rem;color:inherit;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h6{font-size:.78405rem}hgroup{padding:0;margin:0 0 1.45rem}ol,ul{padding:0;margin:0 0 1.45rem 1.45rem;list-style-position:outside;list-style-image:none}dd,dl,figure,p{padding:0;margin:0 0 1.45rem}pre{margin:0 0 1.45rem;font-size:.8rem;line-height:1.42;background:rgba(0,0,0,.04);border-radius:3px;overflow:auto;word-wrap:normal;padding:1.45rem}table{font-size:1rem;line-height:1.45rem;border-collapse:collapse;width:100%}fieldset,table{padding:0;margin:0 0 1.45rem}blockquote{padding:0;margin:0 1.45rem 1.45rem}form,iframe,noscript{padding:0;margin:0 0 1.45rem}hr{padding:0;margin:0 0 calc(1.45rem - 1px);background:rgba(0,0,0,.2);border:none;height:1px}address{padding:0;margin:0 0 1.45rem}b,dt,strong,th{font-weight:700}li{margin-bottom:.725rem}ol li,ul li{padding-left:0}li>ol,li>ul{margin-left:1.45rem;margin-bottom:.725rem;margin-top:.725rem}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:.725rem}code,kbd,samp{font-size:.8rem;line-height:1.45rem}abbr,abbr[title],acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}abbr[title]{text-decoration:none}td,th,thead{text-align:left}td,th{border-bottom:1px solid rgba(0,0,0,.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding:.725rem .96667rem calc(.725rem - 1px)}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}code,tt{background-color:rgba(0,0,0,.04);border-radius:3px;font-family:SFMono-Regular,Consolas,Roboto Mono,Droid Sans Mono,Liberation Mono,Menlo,Courier,monospace;padding:.2em 0}pre code{background:none;line-height:1.42}code:after,code:before,tt:after,tt:before{letter-spacing:-.2em;content:" "}pre code:after,pre code:before,pre tt:after,pre tt:before{content:""}.gatsby-highlight{background-color:#1d1f21;border-radius:.3em;margin:.5em 0;padding:1em;overflow:auto}.gatsby-highlight pre[class*=language-].line-numbers{padding:0 0 0 2.8em;overflow:initial}@media only screen and (max-width:480px){html{font-size:100%}}</style><meta name="generator" content="Gatsby 2.24.67"/><title data-react-helmet="true">Delete this | R@M3$H.N</title><meta data-react-helmet="true" name="description" content="is legal and does what you would expect: it calls your class&#x27;s destructor and free the underlying memory. After  returns, your  pointer value does not change…"/><meta data-react-helmet="true" property="og:title" content="Delete this"/><meta data-react-helmet="true" property="og:description" content="is legal and does what you would expect: it calls your class&#x27;s destructor and free the underlying memory. After  returns, your  pointer value does not change…"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="@rameshnagaraj"/><meta data-react-helmet="true" name="twitter:title" content="Delete this"/><meta data-react-helmet="true" name="twitter:description" content="is legal and does what you would expect: it calls your class&#x27;s destructor and free the underlying memory. After  returns, your  pointer value does not change…"/><link as="script" rel="preload" href="/site/webpack-runtime-118ee52ba5143f7d1f5e.js"/><link as="script" rel="preload" href="/site/framework-de237a875aa45b276a9d.js"/><link as="script" rel="preload" href="/site/app-0c5095f162fd3727fff9.js"/><link as="script" rel="preload" href="/site/styles-407fe62976dc5310c43e.js"/><link as="script" rel="preload" href="/site/92c71b40fabf116e9c1437d16baee1f61fa514e3-4d2039f4b3374774f891.js"/><link as="script" rel="preload" href="/site/component---src-templates-blog-post-js-c293c5aa0dad97d7a7cf.js"/><link as="fetch" rel="preload" href="/site/page-data/blog/2013-10-02-delete-this/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/site/page-data/sq/d/3649515864.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/site/page-data/sq/d/63159454.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/site/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><style data-emotion-css="1pyi7sa">.css-1pyi7sa{background:transparent;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-content:center;-ms-flex-line-pack:center;align-content:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}</style><header class="css-1pyi7sa e1q1yg5j4"><style data-emotion-css="k1grrt">.css-k1grrt{max-width:860px;padding:1rem 1.0875rem;font-size:1.2rem;}</style><div class="css-k1grrt e1q1yg5j0"><p><style data-emotion-css="1kljdew">.css-1kljdew{color:black;margin-left:15px;-webkit-text-decoration:none;text-decoration:none;display:inline-block;position:relative;margin-left:0;}.css-1kljdew::after{content:"";position:absolute;width:100%;-webkit-transform:scaleX(0);-ms-transform:scaleX(0);transform:scaleX(0);height:2px;bottom:0;left:0;background-color:rgba(0,0,0,0.8);-webkit-transform-origin:bottom right;-ms-transform-origin:bottom right;transform-origin:bottom right;-webkit-transition:-webkit-transform 0.4s cubic-bezier(0.86,0,0.07,1);-webkit-transition:transform 0.4s cubic-bezier(0.86,0,0.07,1);transition:transform 0.4s cubic-bezier(0.86,0,0.07,1);}.css-1kljdew:hover::after{-webkit-transform:scaleX(1);-ms-transform:scaleX(1);transform:scaleX(1);-webkit-transform-origin:bottom left;-ms-transform-origin:bottom left;transform-origin:bottom left;}</style><a class="css-1kljdew e1q1yg5j3" href="/site/">R@M3$H.N</a><style data-emotion-css="1wj6arw">.css-1wj6arw{color:black;margin-left:15px;-webkit-text-decoration:none;text-decoration:none;display:inline-block;position:relative;}.css-1wj6arw::after{content:"";position:absolute;width:100%;-webkit-transform:scaleX(0);-ms-transform:scaleX(0);transform:scaleX(0);height:2px;bottom:0;left:0;background-color:rgba(0,0,0,0.8);-webkit-transform-origin:bottom right;-ms-transform-origin:bottom right;transform-origin:bottom right;-webkit-transition:-webkit-transform 0.4s cubic-bezier(0.86,0,0.07,1);-webkit-transition:transform 0.4s cubic-bezier(0.86,0,0.07,1);transition:transform 0.4s cubic-bezier(0.86,0,0.07,1);}.css-1wj6arw:hover::after{-webkit-transform:scaleX(1);-ms-transform:scaleX(1);transform:scaleX(1);-webkit-transform-origin:bottom left;-ms-transform-origin:bottom left;transform-origin:bottom left;}</style><a class="css-1wj6arw e1q1yg5j1" href="/site/blog">Blog</a></p></div></header><style data-emotion-css="1813l62">.css-1813l62{margin:0 auto;max-width:860px;padding:0 1.0875rem 1rem;padding-top:0;}</style><div class="css-1813l62 e1ucglg60"><main><style data-emotion-css="hu0znc">.css-hu0znc{margin:0 auto;max-width:860px;padding:1.45rem 1.0875rem;}</style><div class="css-hu0znc eqbesxl0"><style data-emotion-css="n1d11z">.css-n1d11z{display:inline;border-radius:1em 0 1em 0;background-image:linear-gradient( -100deg,rgba(255,250,150,0.15),rgba(255,250,150,0.8) 100%,rgba(255,250,150,0.25) );}</style><h1 class="css-n1d11z eqbesxl1">Delete this</h1><style data-emotion-css="wvcn4j">.css-wvcn4j{margin-top:10px;color:#606060;}</style><h3 class="css-wvcn4j eqbesxl2">02 October, 2013<!-- --> - <!-- -->6 min read</h3><style data-emotion-css="1rcp9ax">.css-1rcp9ax a{-webkit-text-decoration:none;text-decoration:none;position:relative;}.css-1rcp9ax a::after{content:"";position:absolute;z-index:-1;top:70%;left:-0.1px;right:-0.1px;bottom:0;-webkit-transition:top 0.1s ease-in-out;transition:top 0.1s ease-in-out;background-color:rgba(255,250,150,0.8);}.css-1rcp9ax a:hover::after{top:0;}</style><div class="css-1rcp9ax eqbesxl3"><p><code class="language-text">delete this</code> is legal and does what you would expect: it calls your class's destructor and free the underlying memory. After <code class="language-text">delete this</code> returns, your <code class="language-text">this</code> pointer value does <em>not</em> change, so it is now a dangling pointer that should <em>not</em> be dereferenced. That includes implicit dereferencing using the class's member variables.</p>
<p>It is usually found in reference-counted classes that, when the ref-count is decremented to 0, the<code class="language-text">DecrementRefCount()</code>/<code class="language-text">Release()</code>/whatever member function calls <code class="language-text">delete this</code>.</p>
<p><code class="language-text">delete this</code> is typically considered very bad form for many reasons. It is easy to accidentally access member variables after <code class="language-text">delete this</code>. Caller code might not realize your object has self-destructed.</p>
<p>Also, <code class="language-text">delete this</code> is a "code smell" that your code might not have a symmetric strategy for object ownership (who allocates and who deletes).</p>
<p> </p>
<p>It is risky for one additional reason that hasn't been mentioned yet - you are assuming that the object has been allocated on the heap. This can be difficult to guarantee, although in the case of reference counting implementations isn't generally a problem.</p>
<p> </p>
<p>As long as you're careful, it's OK for an object to commit suicide (<tt>delete</tt> <tt>this</tt>).</p>
<p>Here's how I define "careful":</p>
<ol>
<li>You must be absolutely 100% positively sure that <tt>this</tt> object was allocated via <tt>new</tt> (not by <tt>new[]</tt>, nor by [None](<a href="http://www.parashift.com/c++-faq-lite/placement-new.html">http://www.parashift.com/c++-faq-lite/placement-new.html</a> "[11.10] What is "placement new" and why would I use it?"), nor a local object on the stack, nor a global, nor a member of another object; but by plain ordinary<tt>new</tt>).</li>
<li>You must be absolutely 100% positively sure that your member function will be the last member function invoked on <tt>this</tt> object.</li>
<li>You must be absolutely 100% positively sure that the rest of your member function (after the <tt>delete</tt> <tt>this</tt> line) doesn't touch any piece of <tt>this</tt> object (including calling any other member functions or touching any data members).</li>
<li>You must be absolutely 100% positively sure that no one even touches the <tt>this</tt> pointer itself after the <tt>delete</tt> <tt>this</tt> line. In other words, you must not examine it, compare it with another pointer, compare it with <tt>NULL</tt>, print it, cast it, do anything with it.</li>
</ol>
<p>Naturally the usual caveats apply in cases where your <tt>this</tt> pointer is a pointer to a base class when you don't have a virtual destructor.</p>
<p> </p>
<p>Yes, <code class="language-text">delete this;</code> has defined results, as long as (as you've noted) you assure the object was allocated dynamically, and (of course) never attempt to use the object after it's destroyed.</p>
<p> </p>
<p>Well, in Component Object Model (COM) <code class="language-text">delete this</code> construction can be a part of <code class="language-text">Release</code>method that is called whenever you want to release aquisited object:</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">void IMyInterface::Release()
{
    --instanceCount;
    if(instanceCount == 0)
        delete this;
}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p> 
 </p>
<p>Why would anyone want to do this?", and I thought that I might provide an example usage that I am considering this afternoon.</p>
<p>Legacy code. Uses naked pointers Obj*obj with a delete obj at the end.</p>
<p>Unfortunately I need sometimes, not often, to keep the object alive longer.</p>
<p>I am considering making it a reference counted smart pointer. But there would be <em>lots</em> of code to change, if I was to use <code class="language-text">ref_cnt_ptr&amp;lt;Obj&amp;gt;</code> everywhere. And if you mix naked Obj* and ref_cnt_ptr, you can get the object implicitly deleted when the last ref_cnt_ptr goes away, even though there are Obj* still alive.</p>
<p>So I am thinking about creating an explicit_delete_ref_cnt_ptr. I.e. a reference counted pointer where the delete is only done in an explicit delete routine. Using it in the one place where the existing code knows the lifetime of the object, as well as in my new code that keeps the object alive longer.</p>
<p>Incrementing and decrementing the reference count as explicit_delete_ref_cnt_ptr get manipulated.</p>
<p>But NOT freeing when the reference count is seen to be zero in the explicit_delete_ref_cnt_ptr destructor.</p>
<p>Only freeing when the reference count is seen to be zero in an explicit delete-like operation. E.g. in something like:</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">template&amp;lt;typename T&amp;gt; class explicit_delete_ref_cnt_ptr { 
 private: 
   T* ptr;
   int rc;
   ...
 public: 
   void delete_if_rc0() {
      if( this-&amp;gt;ptr ) {
        this-&amp;gt;rc--;
        if( this-&amp;gt;rc == 0 ) {
           delete this-&amp;gt;ptr;
        }
        this-&amp;gt;ptr = 0;
      }
    }
 };</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>OK, something like that. It's a bit unusual to have a reference counted pointer type not automatically delete the object pointed to in the rc'ed ptr destructor. But it seems like this might make mixing naked pointers and rc'ed pointers a bit safer.</p>
<p>But so far no need for delete this.</p>
<p>But then it occurred to me: if the object pointed to, the pointee, knows that it is being reference counted, e.g. if the count is inside the object (or in some other table), then the routine delete_if_rc0 could be a method of the pointee object, not the (smart) pointer.</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">class Pointee { 
 private: 
   int rc;
   ...
 public: 
   void delete_if_rc0() {
        this-&amp;gt;rc--;
        if( this-&amp;gt;rc == 0 ) {
           delete this;
        }
      }
    }
 };</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Actually, it doesn't need to be a member method at all, but could be a free function:</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">map&amp;lt;void*,int&amp;gt; keepalive_map;
template&amp;lt;typename T&amp;gt;
void delete_if_rc0(T*ptr) {
        void* tptr = (void*)ptr;
        if( keepalive_map[tptr] == 1 ) {
           delete ptr;
        }
};</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>(BTW, I know the code is not quite right - it becomes less readable if I add all the details, so I am leaving it like this.)</p>
<p> </p>
<p>Ideally <em>delete </em>operator should not be used for <em>this </em>pointer. However, if used, then following points must be considered.</p>
<p>1) <em>delete </em>operator works only for objects allocated using operator <em>new</em> (See <a href="http://geeksforgeeks.org/?p=8539">http://geeksforgeeks.org/?p=8539</a>). If the object is created using new, then we can do <em>delete this</em>, otherwise behavior is undefined.</p>
<div>
<div id="highlighter_37910">
<table border="0" cellpadding="0" cellspacing="0">
<tbody>
<tr>
<td>
<div>
<div><code>class</code> <code>A</code></div>
<div><code>{</code></div>
<div><code>&nbsp;&nbsp;</code><code>public</code><code>:</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>void</code> <code>fun()</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>delete</code> <code>this</code><code>;</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></div>
<div><code>};</code></div>
<div></div>
<div><code>int</code> <code>main()</code></div>
<div><code>{</code></div>
<div><code>&nbsp;&nbsp;</code><code>/* Following is Valid */</code></div>
<div><code>&nbsp;&nbsp;</code><code>A *ptr = </code><code>new</code> <code>A;</code></div>
<div><code>&nbsp;&nbsp;</code><code>ptr-&gt;fun();</code></div>
<div><code>&nbsp;&nbsp;</code><code>ptr = NULL </code><code>// make ptr NULL to make sure that things are not accessed using ptr. </code></div>
<div></div>
<div></div>
<div><code>&nbsp;&nbsp;</code><code>/* And following is Invalid: Undefined Behavior */</code></div>
<div><code>&nbsp;&nbsp;</code><code>A a;</code></div>
<div><code>&nbsp;&nbsp;</code><code>a.fun();</code></div>
<div></div>
<div><code>&nbsp;&nbsp;</code><code>getchar</code><code>();</code></div>
<div><code>&nbsp;&nbsp;</code><code>return</code> <code>0;</code></div>
<div><code>}</code></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<ol start="2">
<li>Once <em>delete this </em>is done, any member of the deleted object should not be accessed after deletion.</li>
</ol>
<div>
<div id="highlighter_11532">
<table border="0" cellpadding="0" cellspacing="0">
<tbody>
<tr>
<td>
<div>
<div><code>#include&lt;iostream&gt;</code></div>
<div><code>using</code> <code>namespace</code> <code>std;</code></div>
<div></div>
<div><code>class</code> <code>A</code></div>
<div><code>{</code></div>
<div><code>&nbsp;&nbsp;</code><code>int</code> <code>x;</code></div>
<div><code>&nbsp;&nbsp;</code><code>public</code><code>:</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>A() { x = 0;}</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>void</code> <code>fun() {</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>delete</code> <code>this</code><code>;</code></div>
<div></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>/* Invalid: Undefined Behavior */</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>cout&lt;&lt;x;</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></div>
<div><code>};</code></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<p> </p>
<p><strong>The best thing is to not do <em>delete this </em>at all.</strong></p>
<p>Thanks to <a href="http://geeksforgeeks.org/forum/topic/can-we-use-delete-operator-in-c-for-this-pointer#post-6353">Shekhu </a>for providing above details.</p>
<p>References:<br>
<a href="https://www.securecoding.cert.org/confluence/display/cplusplus/OOP05-CPP.+Avoid+deleting+this">https://www.securecoding.cert.org/confluence/display/cplusplus/OOP05-CPP.+Avoid+deleting+this</a><br>
<a href="http://en.wikipedia.org/wiki/This_%28computer_science%29">http://en.wikipedia.org/wiki/This_%28computer_science%29</a></p>
<p> </p>
<p>END</p></div></div></main></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/blog/2013-10-02-delete-this/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-01365ee183870cafc13e.js"],"app":["/app-0c5095f162fd3727fff9.js"],"component---node-modules-gatsby-plugin-offline-app-shell-js":["/component---node-modules-gatsby-plugin-offline-app-shell-js-0f40d706ebc58d78c1f6.js"],"component---src-pages-404-js":["/component---src-pages-404-js-bff937e505ed3645f489.js"],"component---src-pages-blog-js":["/component---src-pages-blog-js-b8ace911b4b45669d780.js"],"component---src-pages-index-js":["/component---src-pages-index-js-654d7b2799e9b3ade3e0.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-c293c5aa0dad97d7a7cf.js"]};/*]]>*/</script><script src="/site/polyfill-01365ee183870cafc13e.js" nomodule=""></script><script src="/site/component---src-templates-blog-post-js-c293c5aa0dad97d7a7cf.js" async=""></script><script src="/site/92c71b40fabf116e9c1437d16baee1f61fa514e3-4d2039f4b3374774f891.js" async=""></script><script src="/site/styles-407fe62976dc5310c43e.js" async=""></script><script src="/site/app-0c5095f162fd3727fff9.js" async=""></script><script src="/site/framework-de237a875aa45b276a9d.js" async=""></script><script src="/site/webpack-runtime-118ee52ba5143f7d1f5e.js" async=""></script></body></html>