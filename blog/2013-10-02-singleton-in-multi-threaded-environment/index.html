<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/site/styles.67d71cce92f67b5b9860.css">code[class*=language-],pre[class*=language-]{color:#c5c8c6;text-shadow:0 1px rgba(0,0,0,.3);font-family:Inconsolata,Monaco,Consolas,Courier New,Courier,monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#1d1f21}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#7c7c7c}.token.punctuation{color:#c5c8c6}.namespace{opacity:.7}.token.keyword,.token.property,.token.tag{color:#96cbfe}.token.class-name{color:#ffffb6;text-decoration:underline}.token.boolean,.token.constant{color:#9c9}.token.deleted,.token.symbol{color:#f92672}.token.number{color:#ff73fd}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#a8ff60}.token.variable{color:#c6c5fe}.token.operator{color:#ededed}.token.entity{color:#ffffb6;cursor:help}.token.url{color:#96cbfe}.language-css .token.string,.style .token.string{color:#87c38a}.token.atrule,.token.attr-value{color:#f9ee98}.token.function{color:#dad085}.token.regex{color:#e9c062}.token.important{color:#fd971f}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}pre[class*=language-].line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}pre[class*=language-].line-numbers>code{position:relative;white-space:inherit}.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:0;font-size:100%;left:-3.8em;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-ms-user-select:none;user-select:none}.line-numbers-rows>span{display:block;counter-increment:linenumber}.line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}@font-face{font-family:Nunito;font-style:normal;font-display:swap;font-weight:200;src:local("Nunito Extra Light "),local("Nunito-Extra Light"),url(/site/static/nunito-latin-200-2a4f4b0a3646be9d8560178ebc4306e5.woff2) format("woff2"),url(/site/static/nunito-latin-200-249c20ee4450b15795cdde4cbb5f38d8.woff) format("woff")}@font-face{font-family:Nunito;font-style:italic;font-display:swap;font-weight:200;src:local("Nunito Extra Light italic"),local("Nunito-Extra Lightitalic"),url(/site/static/nunito-latin-200italic-89ba5530f3b2c751f2a49e25f31e3f15.woff2) format("woff2"),url(/site/static/nunito-latin-200italic-67d3d63c0ac28ccbc0c0fcbda8e66e04.woff) format("woff")}@font-face{font-family:Nunito;font-style:normal;font-display:swap;font-weight:300;src:local("Nunito Light "),local("Nunito-Light"),url(/site/static/nunito-latin-300-895205e22ad7d4d866df7102352077cd.woff2) format("woff2"),url(/site/static/nunito-latin-300-cad1324b066f52f764cf080d9244c8b2.woff) format("woff")}@font-face{font-family:Nunito;font-style:italic;font-display:swap;font-weight:300;src:local("Nunito Light italic"),local("Nunito-Lightitalic"),url(/site/static/nunito-latin-300italic-f4a613c73f19da60cf08aa42b2a9249b.woff2) format("woff2"),url(/site/static/nunito-latin-300italic-1fde36925a8493f45651815dd89d22a7.woff) format("woff")}@font-face{font-family:Nunito;font-style:normal;font-display:swap;font-weight:400;src:local("Nunito Regular "),local("Nunito-Regular"),url(/site/static/nunito-latin-400-de6068bf97f40206af0b062e262e6213.woff2) format("woff2"),url(/site/static/nunito-latin-400-6386ba6af7b7a5480eb5efda82ff803c.woff) format("woff")}@font-face{font-family:Nunito;font-style:italic;font-display:swap;font-weight:400;src:local("Nunito Regular italic"),local("Nunito-Regularitalic"),url(/site/static/nunito-latin-400italic-6ca737afe5cef0c0a9c9bbfec4e398ff.woff2) format("woff2"),url(/site/static/nunito-latin-400italic-ef2e2a0d9dd85cf89526d1f27f8fbbef.woff) format("woff")}@font-face{font-family:Nunito;font-style:normal;font-display:swap;font-weight:600;src:local("Nunito SemiBold "),local("Nunito-SemiBold"),url(/site/static/nunito-latin-600-b10ecee279e3a8d11d5ec3193b68d8bf.woff2) format("woff2"),url(/site/static/nunito-latin-600-c3de23017bcb95715e6eb11dd6a10fc5.woff) format("woff")}@font-face{font-family:Nunito;font-style:italic;font-display:swap;font-weight:600;src:local("Nunito SemiBold italic"),local("Nunito-SemiBolditalic"),url(/site/static/nunito-latin-600italic-97d4f64b213f3e5163827754c213bb4e.woff2) format("woff2"),url(/site/static/nunito-latin-600italic-4f62b81ff327bd0ffadcb7b82e6c13b2.woff) format("woff")}@font-face{font-family:Nunito;font-style:normal;font-display:swap;font-weight:700;src:local("Nunito Bold "),local("Nunito-Bold"),url(/site/static/nunito-latin-700-91ae827aa880d02ea567979add1da58c.woff2) format("woff2"),url(/site/static/nunito-latin-700-623f5ed42b0b347fb4531ded4e4b57a2.woff) format("woff")}@font-face{font-family:Nunito;font-style:italic;font-display:swap;font-weight:700;src:local("Nunito Bold italic"),local("Nunito-Bolditalic"),url(/site/static/nunito-latin-700italic-b94caac4c88b1fe6c4faf6256646f42e.woff2) format("woff2"),url(/site/static/nunito-latin-700italic-3aabf345871453097c2d8762411d187e.woff) format("woff")}@font-face{font-family:Nunito;font-style:normal;font-display:swap;font-weight:800;src:local("Nunito ExtraBold "),local("Nunito-ExtraBold"),url(/site/static/nunito-latin-800-36e4c9b478c2e2adb339a76d819eed7e.woff2) format("woff2"),url(/site/static/nunito-latin-800-33c733aff58ea08126616f346cbf4f4a.woff) format("woff")}@font-face{font-family:Nunito;font-style:italic;font-display:swap;font-weight:800;src:local("Nunito ExtraBold italic"),local("Nunito-ExtraBolditalic"),url(/site/static/nunito-latin-800italic-0f20328772c0d84250ef397c129607fb.woff2) format("woff2"),url(/site/static/nunito-latin-800italic-672d2afe4f40a766e46ff95379550c4f.woff) format("woff")}@font-face{font-family:Nunito;font-style:normal;font-display:swap;font-weight:900;src:local("Nunito Black "),local("Nunito-Black"),url(/site/static/nunito-latin-900-b296e05d0932e16d500b753becdb338e.woff2) format("woff2"),url(/site/static/nunito-latin-900-cbf4339e858edf2b14d20140b2887343.woff) format("woff")}@font-face{font-family:Nunito;font-style:italic;font-display:swap;font-weight:900;src:local("Nunito Black italic"),local("Nunito-Blackitalic"),url(/site/static/nunito-latin-900italic-ae87e7b4e2d3825919b9bc6c82039b80.woff2) format("woff2"),url(/site/static/nunito-latin-900italic-602859bd469800c6205701f5a16b1a1b.woff) format("woff")}code{background-color:rgba(0,0,0,.04)}body{margin:0;font-family:Nunito,Avenir,Helvetica,"sans-serif";-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{font-style:normal;color:rgba(0,0,0,.8);-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:112.5%/1.45em georgia,serif;box-sizing:border-box;overflow-y:scroll}*,:after,:before{box-sizing:inherit}body{color:rgba(0,0,0,.8);font-weight:400;word-wrap:break-word;-webkit-font-kerning:normal;font-kerning:normal;-ms-font-feature-settings:"kern","liga","clig","calt";font-feature-settings:"kern","liga","clig","calt"}img{max-width:100%;padding:0;margin:0 0 1.45rem}h1{font-size:2.25rem}h1,h2{padding:0;margin:0 0 1.45rem;color:inherit;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h2{font-size:1.62671rem}h3{font-size:1.38316rem}h3,h4{padding:0;margin:0 0 1.45rem;color:inherit;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h4{font-size:1rem}h5{font-size:.85028rem}h5,h6{padding:0;margin:0 0 1.45rem;color:inherit;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h6{font-size:.78405rem}hgroup{padding:0;margin:0 0 1.45rem}ol,ul{padding:0;margin:0 0 1.45rem 1.45rem;list-style-position:outside;list-style-image:none}dd,dl,figure,p{padding:0;margin:0 0 1.45rem}pre{margin:0 0 1.45rem;font-size:.8rem;line-height:1.42;background:rgba(0,0,0,.04);border-radius:3px;overflow:auto;word-wrap:normal;padding:1.45rem}table{font-size:1rem;line-height:1.45rem;border-collapse:collapse;width:100%}fieldset,table{padding:0;margin:0 0 1.45rem}blockquote{padding:0;margin:0 1.45rem 1.45rem}form,iframe,noscript{padding:0;margin:0 0 1.45rem}hr{padding:0;margin:0 0 calc(1.45rem - 1px);background:rgba(0,0,0,.2);border:none;height:1px}address{padding:0;margin:0 0 1.45rem}b,dt,strong,th{font-weight:700}li{margin-bottom:.725rem}ol li,ul li{padding-left:0}li>ol,li>ul{margin-left:1.45rem;margin-bottom:.725rem;margin-top:.725rem}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:.725rem}code,kbd,samp{font-size:.8rem;line-height:1.45rem}abbr,abbr[title],acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}abbr[title]{text-decoration:none}td,th,thead{text-align:left}td,th{border-bottom:1px solid rgba(0,0,0,.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding:.725rem .96667rem calc(.725rem - 1px)}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}code,tt{background-color:rgba(0,0,0,.04);border-radius:3px;font-family:SFMono-Regular,Consolas,Roboto Mono,Droid Sans Mono,Liberation Mono,Menlo,Courier,monospace;padding:.2em 0}pre code{background:none;line-height:1.42}code:after,code:before,tt:after,tt:before{letter-spacing:-.2em;content:" "}pre code:after,pre code:before,pre tt:after,pre tt:before{content:""}.gatsby-highlight{background-color:#1d1f21;border-radius:.3em;margin:.5em 0;padding:1em;overflow:auto}.gatsby-highlight pre[class*=language-].line-numbers{padding:0 0 0 2.8em;overflow:initial}@media only screen and (max-width:480px){html{font-size:100%}}</style><meta name="generator" content="Gatsby 2.24.67"/><title data-react-helmet="true">Singleton in Multi-Threaded Environment | R@M3$H.N</title><meta data-react-helmet="true" name="description" content="The code posted here should be considered as pseudo-code, no particular language is assumed. And also it is assumed that the reader is already familiar with the…"/><meta data-react-helmet="true" property="og:title" content="Singleton in Multi-Threaded Environment"/><meta data-react-helmet="true" property="og:description" content="The code posted here should be considered as pseudo-code, no particular language is assumed. And also it is assumed that the reader is already familiar with the…"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="@rameshnagaraj"/><meta data-react-helmet="true" name="twitter:title" content="Singleton in Multi-Threaded Environment"/><meta data-react-helmet="true" name="twitter:description" content="The code posted here should be considered as pseudo-code, no particular language is assumed. And also it is assumed that the reader is already familiar with the…"/><link as="script" rel="preload" href="/site/webpack-runtime-118ee52ba5143f7d1f5e.js"/><link as="script" rel="preload" href="/site/framework-de237a875aa45b276a9d.js"/><link as="script" rel="preload" href="/site/app-0c5095f162fd3727fff9.js"/><link as="script" rel="preload" href="/site/styles-407fe62976dc5310c43e.js"/><link as="script" rel="preload" href="/site/92c71b40fabf116e9c1437d16baee1f61fa514e3-4d2039f4b3374774f891.js"/><link as="script" rel="preload" href="/site/component---src-templates-blog-post-js-c293c5aa0dad97d7a7cf.js"/><link as="fetch" rel="preload" href="/site/page-data/blog/2013-10-02-singleton-in-multi-threaded-environment/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/site/page-data/sq/d/3649515864.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/site/page-data/sq/d/63159454.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/site/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><style data-emotion-css="1pyi7sa">.css-1pyi7sa{background:transparent;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-content:center;-ms-flex-line-pack:center;align-content:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}</style><header class="css-1pyi7sa e1q1yg5j4"><style data-emotion-css="k1grrt">.css-k1grrt{max-width:860px;padding:1rem 1.0875rem;font-size:1.2rem;}</style><div class="css-k1grrt e1q1yg5j0"><p><style data-emotion-css="1kljdew">.css-1kljdew{color:black;margin-left:15px;-webkit-text-decoration:none;text-decoration:none;display:inline-block;position:relative;margin-left:0;}.css-1kljdew::after{content:"";position:absolute;width:100%;-webkit-transform:scaleX(0);-ms-transform:scaleX(0);transform:scaleX(0);height:2px;bottom:0;left:0;background-color:rgba(0,0,0,0.8);-webkit-transform-origin:bottom right;-ms-transform-origin:bottom right;transform-origin:bottom right;-webkit-transition:-webkit-transform 0.4s cubic-bezier(0.86,0,0.07,1);-webkit-transition:transform 0.4s cubic-bezier(0.86,0,0.07,1);transition:transform 0.4s cubic-bezier(0.86,0,0.07,1);}.css-1kljdew:hover::after{-webkit-transform:scaleX(1);-ms-transform:scaleX(1);transform:scaleX(1);-webkit-transform-origin:bottom left;-ms-transform-origin:bottom left;transform-origin:bottom left;}</style><a class="css-1kljdew e1q1yg5j3" href="/site/">R@M3$H.N</a><style data-emotion-css="1wj6arw">.css-1wj6arw{color:black;margin-left:15px;-webkit-text-decoration:none;text-decoration:none;display:inline-block;position:relative;}.css-1wj6arw::after{content:"";position:absolute;width:100%;-webkit-transform:scaleX(0);-ms-transform:scaleX(0);transform:scaleX(0);height:2px;bottom:0;left:0;background-color:rgba(0,0,0,0.8);-webkit-transform-origin:bottom right;-ms-transform-origin:bottom right;transform-origin:bottom right;-webkit-transition:-webkit-transform 0.4s cubic-bezier(0.86,0,0.07,1);-webkit-transition:transform 0.4s cubic-bezier(0.86,0,0.07,1);transition:transform 0.4s cubic-bezier(0.86,0,0.07,1);}.css-1wj6arw:hover::after{-webkit-transform:scaleX(1);-ms-transform:scaleX(1);transform:scaleX(1);-webkit-transform-origin:bottom left;-ms-transform-origin:bottom left;transform-origin:bottom left;}</style><a class="css-1wj6arw e1q1yg5j1" href="/site/blog">Blog</a></p></div></header><style data-emotion-css="1813l62">.css-1813l62{margin:0 auto;max-width:860px;padding:0 1.0875rem 1rem;padding-top:0;}</style><div class="css-1813l62 e1ucglg60"><main><style data-emotion-css="hu0znc">.css-hu0znc{margin:0 auto;max-width:860px;padding:1.45rem 1.0875rem;}</style><div class="css-hu0znc eqbesxl0"><style data-emotion-css="n1d11z">.css-n1d11z{display:inline;border-radius:1em 0 1em 0;background-image:linear-gradient( -100deg,rgba(255,250,150,0.15),rgba(255,250,150,0.8) 100%,rgba(255,250,150,0.25) );}</style><h1 class="css-n1d11z eqbesxl1">Singleton in Multi-Threaded Environment</h1><style data-emotion-css="wvcn4j">.css-wvcn4j{margin-top:10px;color:#606060;}</style><h3 class="css-wvcn4j eqbesxl2">02 October, 2013<!-- --> - <!-- -->12 min read</h3><style data-emotion-css="1rcp9ax">.css-1rcp9ax a{-webkit-text-decoration:none;text-decoration:none;position:relative;}.css-1rcp9ax a::after{content:"";position:absolute;z-index:-1;top:70%;left:-0.1px;right:-0.1px;bottom:0;-webkit-transition:top 0.1s ease-in-out;transition:top 0.1s ease-in-out;background-color:rgba(255,250,150,0.8);}.css-1rcp9ax a:hover::after{top:0;}</style><div class="css-1rcp9ax eqbesxl3"><p><em>The code posted here should be considered as pseudo-code, no particular language is assumed. And also it is assumed that the reader is already familiar with the Singleton pattern, i.e. I am not going to discuss what is a Singleton, when we should use it etc. in detail. Rather I am going to discuss about the difficulties of implementing Singleton in multi-threaded environment. And there are cases where Singleton is considered evil or Anti-Pattern, but again, that is a separate discussion.</em></p>
<p>If people are asked to name a design pattern, the most commonly uttered name is the Singleton. It is one of the most widely used patterns (and most abused, too). The idea behind the Singleton is simple. It ensures that the Singleton class has only one instance and provides a global access point for it. We can use a Singleton when the presence of multiple instances can potentially damage the system, and we need global access to the single instance. Let’s first see the classical implementation of Singleton:</p>
<div>
<div id="highlighter_131632">
<table border="0" cellpadding="0" cellspacing="0">
<tbody>
<tr>
<td>
<div>1</div>
<div>2</div>
<div>3</div>
<div>4</div>
<div>5</div>
<div>6</div>
<div>7</div>
<div>8</div>
<div>9</div>
<div>10</div>
<div>11</div>
<div>12</div>
<div>13</div>
</td>
<td>
<div>
<div><code>public</code> <code>class</code> <code>Singleton {</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>private</code> <code>static</code> <code>Singleton _instance = </code><code>null</code><code>;</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>private</code> <code>Singleton() {}</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>public</code> <code>static</code> <code>Singleton getInstance() {</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>if</code> <code>(_instance == </code><code>null</code><code>) {</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>_instance = </code><code>new</code> <code>Singleton();</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>return</code> <code>_instance;</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></div>
<div><code>}</code></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The implementation is straight forward. The constructor of <code class="language-text">Singleton</code> is private, so it is not possible to instantiate it from outside. The only way to get an instance is to call static<code class="language-text">getInstance()</code> method. <code class="language-text">getInstance()</code> first checks whether an instance is already created. If not, then it creates an instance, refers it via private static member <code class="language-text">_instance</code> and then returns that. And if already created then it returns the previously created <code class="language-text">_instance</code>. Thus only the first call to <code class="language-text">getInstance()</code> instantiates a <code class="language-text">Singleton</code> object and any further call returns the same object. Also note that the object is not instantiated until <code class="language-text">getInstance()</code> is called, i.e. we only create that when actually required. This is called lazy initialization and becomes helpful if the object is resource hungry.</p>
<p>This looks very simple and straight forward implementation. But we have a slight problem with this. This classical implementation is not thread safe. Lets see what may happen in the presence of two threads.</p>
<ol>
<li>Thread-1 enters <code class="language-text">getInstance()</code> for the first time and sees that <code class="language-text">_instance</code> is null and thus the condition is true.</li>
<li>Before instantiating the object a thread switch occur.</li>
<li>Thread-2 enters <code class="language-text">getInstance()</code> and it will see <code class="language-text">_instance</code> null too, as the instantiation by Thread-1 is not completed yet.</li>
<li>Thread-2 instantiate new object and then return.</li>
<li>Thread-1 knows nothing about Thread-2. So when it gets its turn again, it instantiates another object and returns that. At this point we have two instances of <code class="language-text">Singleton</code> which violates the fundamental purpose of the pattern.</li>
</ol>
<p>So what can we do solve this problem? The easiest solution comes up if we don’t want the lazy initialization. Something like this:</p>
<div>
<div id="highlighter_639874">
<table border="0" cellpadding="0" cellspacing="0">
<tbody>
<tr>
<td>
<div>1</div>
<div>2</div>
<div>3</div>
<div>4</div>
<div>5</div>
<div>6</div>
<div>7</div>
<div>8</div>
<div>9</div>
</td>
<td>
<div>
<div><code>public</code> <code>class</code> <code>Singleton {</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>private</code> <code>static</code> <code>Singleton _instance = </code><code>new</code> <code>Singleton();</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>private</code> <code>Singleton() {}</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>public</code> <code>static</code> <code>Singleton getInstance() {</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>return</code> <code>_instance;</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></div>
<div><code>}</code></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>This is guaranteed to be thread safe. The only cost that we pay is that we loose the lazy initialization. If the singleton object is created at every run or the cost of the object is not so high then probably this is the best approach to implement a Singleton in multi-threaded environment.</p>
<p>But what if we want the lazy initialization? The general approach to write a thread safe code is to acquire a lock before accessing the shared resource. We can acquire a thread lock after entering <code class="language-text">getInstance()</code>. Something like this:</p>
<div>
<div id="highlighter_899681">
<table border="0" cellpadding="0" cellspacing="0">
<tbody>
<tr>
<td>
<div>1</div>
<div>2</div>
<div>3</div>
<div>4</div>
<div>5</div>
<div>6</div>
<div>7</div>
<div>8</div>
<div>9</div>
</td>
<td>
<div>
<div><code>public</code> <code>static</code> <code>Singleton getInstance() {</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>acquire_lock();</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>if</code> <code>(_instance == </code><code>null</code><code>) {</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>_instance = </code><code>new</code> <code>Singleton();</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>release_lock();</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>return</code> <code>_instance;</code></div>
<div><code>}</code></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Again, this is guaranteed to be thread safe. Thread-2 can not proceed until Thread-1 completes the instantiation and releases the lock. Obviously after acquiring the lock Thread-2 will see <code class="language-text">_instance</code> non-null and won’t create a separate instance. But unfortunately we have slight problem with this method, namely performance. Acquiring a thread lock is a very costly operation. Acquiring a lock at every call of <code class="language-text">getInstance()</code> may affect the overall performance severely, specially when the calls are frequent. And to make matter worse, we only need the lock for the first time. Once <code class="language-text">_instance</code> is set up with a valid value, there is no need of the locking. But we are acquiring the lock every time and thus wasting our resource. The very idea of lazy initialization is to use resource efficiently, but this method of locking seems overkilling.</p>
<p>Is there any way to get around this problem? We have already realized that the lock is only needed for the first time. There is no need to acquire lock once <code class="language-text">_instance</code> is initialized. So why don’t we acquire the lock only if <code class="language-text">_instance</code> is null, like this:</p>
<div>
<div id="highlighter_603973">
<table border="0" cellpadding="0" cellspacing="0">
<tbody>
<tr>
<td>
<div>1</div>
<div>2</div>
<div>3</div>
<div>4</div>
<div>5</div>
<div>6</div>
<div>7</div>
<div>8</div>
<div>9</div>
</td>
<td>
<div>
<div><code>public</code> <code>static</code> <code>Singleton getInstance() {</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>if</code> <code>(_instance == </code><code>null</code><code>) {</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>acquire_lock();</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>_instance = </code><code>new</code> <code>Singleton();</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>release_lock();</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>return</code> <code>_instance;</code></div>
<div><code>}</code></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>A clever thought. But this will not work. Why? Thread-1 may see the condition true and enter the condition, but before acquiring the lock thread switch may occur. Then Thread-2 will again find the condition true and thus we are in the same situation as before.</p>
<p>Can we fix this? Indeed we can. And with a slight modification. We only need to check<code class="language-text">_instance</code> against null again after acquiring the lock. Like this:</p>
<div>
<div id="highlighter_901907">
<table border="0" cellpadding="0" cellspacing="0">
<tbody>
<tr>
<td>
<div>1</div>
<div>2</div>
<div>3</div>
<div>4</div>
<div>5</div>
<div>6</div>
<div>7</div>
<div>8</div>
<div>9</div>
<div>10</div>
<div>11</div>
</td>
<td>
<div>
<div><code>public</code> <code>static</code> <code>Singleton getInstance() {</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>if</code> <code>(_instance == </code><code>null</code><code>) {</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>acquire_lock();</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>if</code> <code>(_instance == </code><code>null</code><code>) {</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>_instance = </code><code>new</code> <code>Singleton();</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>release_lock();</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>return</code> <code>_instance;</code></div>
<div><code>}</code></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Lets see what happens with the previous situation:</p>
<ol>
<li>Thread-1 enters the condition but before acquiring the lock thread switch occurs.</li>
<li>Thread-2 enters the condition, acquires lock, instantiates, releases lock and returns like before.</li>
<li>Thread-1 acquires the lock. But now it will see that <code class="language-text">_instance</code> is non-null and thus it will not create a new object. It will simply release the lock and return the object created by Thread-2.</li>
</ol>
<p>Looks like our problem with multiple threads is finally finished. This approach of checking twice is a design pattern in its own right and is called Double Checked Locking Pattern.</p>
<p>Unfortunately, this is NOT guaranteed to work either. The reason is our modern compilers are too smart in optimizing things. An optimizing compiler (all modern compilers are) can reorder the instructions for various reasons. It can reorder read/write calls to improve cache performance, it may try to run as many instructions as possible in parallel when multiple execution units are present (all our modern CPUs has multiple execution units) and for many such reasons. A concrete example might clarify.</p>
<div>
<div id="highlighter_93111">
<table border="0" cellpadding="0" cellspacing="0">
<tbody>
<tr>
<td>
<div>1</div>
<div>2</div>
<div>3</div>
</td>
<td>
<div>
<div><code>int</code> <code>a = </code><code>10</code><code>;</code></div>
<div><code>int</code> <code>b = </code><code>20</code><code>;</code></div>
<div><code>int</code> <code>c = a + b;</code></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Here the compiler guarantees that the value of <code class="language-text">c</code> will be 30, but it does not guarantee anything else about <code class="language-text">a</code> and <code class="language-text">b</code>. It can completely eliminate the first two instructions as constant expression, it can execute 1st one first and then 2nd one, or it can execute 2nd one first and then 1st one, or even it can execute them in parallel if multiple execution units are present. The summary is: we can not depend on it.</p>
<p>Lets back to our double checked locking code. When <code class="language-text">_instance = new Singleton()</code> is executed three things happen mainly. A portion of memory is allocated for <code class="language-text">Singleton</code> object, that memory is initialized with the object’s data and finally <code class="language-text">_instance</code> points to that memory location. <code class="language-text">_instance</code> is valid only when the initialization is complete. Here the catch is that the compiler may change the order of these, i.e. it may first allocate the memory and make<code class="language-text">_instance</code> point to that memory and then go for the initialization of the object. It is also possible that the initialization is taking place in another execution unit. Why the compiler would do so is a matter of study in compiler optimization theory, but the fact is <code class="language-text">_instance</code>may point to an uninitialized memory. Lets see what may happen to our double checked locking code in this case:</p>
<ol>
<li>Thread-1 enters <code class="language-text">getInstance()</code>, acquires the lock and starts the instantiation process. It allocates the memory and makes <code class="language-text">_instance</code> point to it.</li>
<li>Before the initialization of created object is complete, a thread switch is occurred.</li>
<li>Thread-2 enters <code class="language-text">getInstance()</code> and finds <code class="language-text">_instance</code> non-null, as it is already pointed to the allocated memory by Thread-1.</li>
<li>As Thread-2 finds <code class="language-text">_instance</code> non-null, it thinks that the instantiation is complete and returns that. It has no way to know that the initialization is yet to be completed.</li>
<li>As a result the caller of <code class="language-text">getInstance()</code> in Thread-2 receives something that is not initialized properly. If it tries to use the object before the initialization is actually completed, it will create major problem and may even crash the program.</li>
</ol>
<p>To make matters worse, if this occurs than it will be very difficult to figure out the exact reason of the unexpected behavior or crash, as this will happen in random. How can we deal with this? Well … this might be heart breaking, but there is NO single way which can solve this problem in ALL compilers/hardwares/platforms. We have few work around depending on the platform.</p>
<ol><li>Marking a memory location&nbsp;<code>volatile</code>&nbsp;denotes to the compiler that this memory can be changed in ways not known to the compiler and thus prevents such optimization. Originally that was introduced to handle memory-mapped I/O and was not related to thread, but J2SE 5.0 and Visual C++ 5.0 ensures that&nbsp;<code>volatile</code>&nbsp;works correctly with multiple threads. So making&nbsp;<code>_instance volatile</code>&nbsp;will solve the problem for them. But that is not guaranteed to work with versions of J2SE lower than 5.0 or lower than Visual C++ 5.0 or in other C++ compilers. And also using&nbsp;<code>volatile</code>&nbsp;may affect the performance too.</li><li>A memory barrier instruction forces that all read/write instructions before the barrier must be completed before any read/write operation is executed after the barrier. For systems that support memory barrier we can solve this problem by introducing a memory barrier after the instantiation of Singleton object and by introducing a flag as test condition. Something like this:
<div>
<div id="highlighter_728485">
<table border="0" cellpadding="0" cellspacing="0">
<tbody>
<tr>
<td>
<div>1</div>
<div>2</div>
<div>3</div>
<div>4</div>
<div>5</div>
<div>6</div>
<div>7</div>
<div>8</div>
<div>9</div>
<div>10</div>
<div>11</div>
<div>12</div>
<div>13</div>
<div>14</div>
<div>15</div>
<div>16</div>
<div>17</div>
<div>18</div>
<div>19</div>
<div>20</div>
</td>
<td>
<div>
<div><code>public</code> <code>class</code> <code>Singleton {</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>private</code> <code>static</code> <code>Singleton _instance = </code><code>null</code><code>;</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>private</code> <code>static</code> <code>bool flag = </code><code>false</code><code>;</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>private</code> <code>Singleton() {}</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>public</code> <code>static</code> <code>Singleton getInstance() {</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>if</code> <code>(!flag) {</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>acquire_lock();</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>if</code> <code>(!flag) {</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>_instance = </code><code>new</code> <code>Singleton();</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>memory_barrier();</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>flag = </code><code>true</code><code>;</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>release_lock();</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>return</code> <code>_instance;</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></div>
<div><code>}</code></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Note that now a new flag is added as the test condition.&nbsp;<code>_instance</code>&nbsp;may point to uninitialized memory, but the memory barrier instruction before&nbsp;<code>flag = true</code>&nbsp;will ensure that flag will be false until the object is fully initialized. The combination of memory barrier and new flag instead of&nbsp;<code>_instance</code>&nbsp;as test condition solves the problem. But the downside of this solution is that if the compiler used does not support a memory barrier instruction natively (.NET has a memory barrier instruction) then it might be difficult to implement a barrier correctly, and may even require assembly coding.</p></li><li>In addition to double checked locking pattern there is an another approach to implement Singleton correctly known as&nbsp;<code>Initialization on demand holder idiom</code>. This method works on all versions of Java.</li></ol>
<p>None of the solutions works in all platforms. All of them exploit platform/compiler specific features. May be the best solution is to ignore lazy initialization. And if we want to stick with lazy initialization, then performance of the full locking version of <code class="language-text">getInstance()</code> (where lock is acquired after entering <code class="language-text">getInstance()</code>) can be improved by minimizing calls to<code class="language-text">getInstance()</code> like this:</p>
<div>
<div id="highlighter_158460">
<table border="0" cellpadding="0" cellspacing="0">
<tbody>
<tr>
<td>
<div>1</div>
<div>2</div>
<div>3</div>
<div>4</div>
<div>5</div>
<div>6</div>
<div>7</div>
<div>8</div>
<div>9</div>
<div>10</div>
</td>
<td>
<div>
<div><code>// requires three calls and thus acquires lock three times</code></div>
<div><code>Singleton.getInstance().method1();</code></div>
<div><code>Singleton.getInstance().method2();</code></div>
<div><code>Singleton.getInstance().method3();</code></div>
<div></div>
<div><code>// requires only one call and thus acquires lock only ones </code></div>
<div><code>Singleton instance = Singleton.getInstance();</code></div>
<div><code>instance.method1();</code></div>
<div><code>instance.method2();</code></div>
<div><code>instance.method3();</code></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>This is not a real solution to the problem, but it can improve performance significantly in practice.</p>
<p>JAVA:</p>
<p>One of the Better way of writing a Singleton is using the Static Inner Helper Class (Bill Pugh Method).</p>
<pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> Singleton <span class="token punctuation">{</span>
 
    <span class="token keyword">private</span> Singleton<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
     
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> SingletonHelper<span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Singleton m_instance <span class="token operator">=</span> <span class="token keyword">new</span> Singleton<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
     
    <span class="token keyword">public</span> <span class="token keyword">static</span> Singleton getInstance<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> SingletonHelper<span class="token punctuation">.</span>m_instance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>When the singleton class is loaded, SingletonHelper class is not loaded into memory and only when someone calls the getInstance method, this class gets loaded and creates the Singleton class instance.<br>
This is the most widely used approach for Singleton class as it doesn’t require synchronization.</p>
<p>END</p></div></div></main></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/blog/2013-10-02-singleton-in-multi-threaded-environment/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-01365ee183870cafc13e.js"],"app":["/app-0c5095f162fd3727fff9.js"],"component---node-modules-gatsby-plugin-offline-app-shell-js":["/component---node-modules-gatsby-plugin-offline-app-shell-js-0f40d706ebc58d78c1f6.js"],"component---src-pages-404-js":["/component---src-pages-404-js-bff937e505ed3645f489.js"],"component---src-pages-blog-js":["/component---src-pages-blog-js-b8ace911b4b45669d780.js"],"component---src-pages-index-js":["/component---src-pages-index-js-654d7b2799e9b3ade3e0.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-c293c5aa0dad97d7a7cf.js"]};/*]]>*/</script><script src="/site/polyfill-01365ee183870cafc13e.js" nomodule=""></script><script src="/site/component---src-templates-blog-post-js-c293c5aa0dad97d7a7cf.js" async=""></script><script src="/site/92c71b40fabf116e9c1437d16baee1f61fa514e3-4d2039f4b3374774f891.js" async=""></script><script src="/site/styles-407fe62976dc5310c43e.js" async=""></script><script src="/site/app-0c5095f162fd3727fff9.js" async=""></script><script src="/site/framework-de237a875aa45b276a9d.js" async=""></script><script src="/site/webpack-runtime-118ee52ba5143f7d1f5e.js" async=""></script></body></html>